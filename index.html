<!-- 
    HANDBALL PUTZPLAN GENERATOR
    Version: 2.1
    Features: 
    - NEUER Multi-Kriterien-Fairness-Score
    - Anwesenheit vs. Freilos getrennt (attendanceCount)
    - Schicht-spezifische Optimierung
    - Globale Putzmaschinen-Auswahl
    - Automatische Datenmigration von v1.4 & v2.0
    - Cloud-Sync (Firebase), Dynamische 7er-Teams, CSV-Export, Editor-Modus
    
    NEU in v2.1:
    - Umbenennung Niklas T. ‚Üí Patrick C. (mit Datenmigration)
    - Putzplan editierbar vor dem Speichern
    - Nachreichen-Funktion f√ºr nachtr√§gliche Eintragungen
-->
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Handball Putzplan Generator v2.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .container-card { background-color: white; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .toggle-switch { width: 44px; height: 24px; background-color: #ccc; border-radius: 9999px; position: relative; cursor: pointer; transition: background-color 0.3s; }
        .toggle-switch.checked { background-color: #10b981; }
        .toggle-switch::after { content: ''; position: absolute; width: 20px; height: 20px; border-radius: 50%; background-color: white; top: 2px; left: 2px; transition: transform 0.3s; }
        .toggle-switch.checked::after { transform: translateX(20px); }
        .checkbox-item { cursor: pointer; transition: background-color 0.1s; }
        .checkbox-item:hover { background-color: #f8fafc; }
        #whatsapp-output { resize: none; height: 150px; font-family: monospace; white-space: pre; overflow-wrap: normal; overflow-x: auto; }
        .stat-badge { font-weight: bold; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; }
        
        .modal-container {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .modal-scrollable-content {
            max-height: 85vh;
            overflow-y: auto;
            width: 100%;
        }

        #stats-card-container {
            display: grid;
            gap: 1rem;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        }
        .player-stat-card {
            cursor: pointer;
            transition: transform 0.1s;
        }
        .player-stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px -3px rgba(0, 0, 0, 0.15);
        }
        
        /* Fairness Score Visualisierung */
        .fairness-bar {
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(to right, #10b981 0%, #fbbf24 50%, #ef4444 100%);
        }
        .fairness-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            transform: translateX(-50%);
        }
        
        /* Balance-Anzeige */
        .balance-good { color: #10b981; }
        .balance-ok { color: #f59e0b; }
        .balance-bad { color: #ef4444; }
        
        /* NEU: Editierbare Putzplan-Elemente */
        .editable-assignment {
            transition: all 0.2s;
        }
        .editable-assignment:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .swap-btn {
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        .swap-btn:hover {
            opacity: 1;
        }
        .player-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            background: #e0e7ff;
            color: #3730a3;
            margin: 2px;
        }
        .player-chip.pm {
            background: #fef3c7;
            color: #92400e;
            font-weight: 600;
        }
        .player-chip .remove-btn {
            cursor: pointer;
            margin-left: 2px;
            opacity: 0.5;
        }
        .player-chip .remove-btn:hover {
            opacity: 1;
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==========================================
        // GLOBALE KONFIGURATION
        // ==========================================
        
        let db = null;
        let playerStats = {};
        let selectedPlayers = new Set();
        let AppConfig = {};
        let assignmentCache = null; 
        let isAuthReady = false;
        let userId = null;
        
        const PLAYERS_PER_UNIT = 7; // 6 Crew + 1 Putzmaschine
        
        // GE√ÑNDERT: Niklas T. ‚Üí Patrick C.
        const PLAYER_NAMES = [
            "Alex", "W√ºpping", "Fabian", "Baumi", "Fred", "Hannes", "Lauryn", "Marius",
            "Marvin L.", "Matze", "Maurice", "Nico", "Patrick C.", "Niklas M.", "Pascal",
            "Patrick", "Strooti", "Tim", "Tobi", "Viktor"
        ];
        
        // Mapping f√ºr Datenmigration
        const NAME_MIGRATIONS = {
            "Niklas T.": "Patrick C."
        };
        
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'handball-putzplan-2025';
        const STATS_COLLECTION = "stats";
        const CONFIG_DOC = "config";

        // ==========================================
        // FAIRNESS-GEWICHTUNG (anpassbar!)
        // ==========================================
        
        const FAIRNESS_WEIGHTS = {
            totalPutz: 1.0,           // Gesamtdienste
            freilosCount: 0.8,        // Freilose (wer viele hat, soll eher putzen)
            fruehSpaetBalance: 1.2,   // Fr√ºh/Sp√§t-Ungleichgewicht (wichtig!)
            pmFruehSpaetBalance: 1.0, // PM Fr√ºh/Sp√§t-Ungleichgewicht
            lastAssigned: 0.3,        // Zeitlicher Abstand
        };

        // ==========================================
        // FIREBASE FUNKTIONEN
        // ==========================================
        
        function getPlayerDocRef(playerName) {
            return doc(db, `artifacts/${APP_ID}/public/data/${STATS_COLLECTION}`, playerName);
        }

        function getConfigDocRef() {
            return doc(db, `artifacts/${APP_ID}/public/data/${CONFIG_DOC}`, "main");
        }
        
        async function loadConfig() {
            if (!db || !isAuthReady) return;
            const docSnap = await getDoc(getConfigDocRef());
            AppConfig = {
                nextPutzmaschineType: 'Fr√ºh',
                totalTrainings: 0,
                dataVersion: '2.1',
                migrationDone: false,
                ...(docSnap.exists() ? docSnap.data() : {})
            };
        }
        
        // NEU: Template mit attendanceCount
        function getPlayerStatsTemplate(name) {
            return {
                name: name,
                // NEU: Anwesenheit z√§hlt ALLE Anwesenheiten (Putzen + Freilos)
                attendanceCount: 0,
                // Freilose separat
                freilosCount: 0,
                // Putzdienste
                totalPutz: 0,
                fruehPutzCount: 0,
                spaetPutzCount: 0,
                // Putzmaschine
                putzmaschineFruehCount: 0,
                putzmaschineSpaetCount: 0,
                // Zeitstempel
                lastAssigned: 0,
            };
        }
        
        // Datenmigration von v1.4 auf v2.0+
        function migratePlayerData(oldData, name) {
            const template = getPlayerStatsTemplate(name);
            const migrated = { ...template, ...oldData };
            
            // Migration: Wenn attendanceCount nicht existiert, berechne es
            if (oldData && typeof oldData.attendanceCount === 'undefined') {
                migrated.attendanceCount = (oldData.totalPutz || 0) + (oldData.freilosCount || 0);
                console.log(`Migration f√ºr ${name}: attendanceCount = ${migrated.attendanceCount}`);
            }
            
            // Name korrigieren
            migrated.name = name;
            
            return migrated;
        }
        
        // NEU: Migration von Niklas T. zu Patrick C.
        async function migratePlayerNames() {
            if (AppConfig.migrationDone) return;
            
            for (const [oldName, newName] of Object.entries(NAME_MIGRATIONS)) {
                try {
                    const oldDocRef = getPlayerDocRef(oldName);
                    const oldDocSnap = await getDoc(oldDocRef);
                    
                    if (oldDocSnap.exists()) {
                        const oldData = oldDocSnap.data();
                        console.log(`Migriere ${oldName} ‚Üí ${newName}:`, oldData);
                        
                        // Daten zum neuen Namen kopieren
                        const newDocRef = getPlayerDocRef(newName);
                        const newData = { ...oldData, name: newName };
                        await setDoc(newDocRef, newData, { merge: true });
                        
                        // Alten Eintrag l√∂schen
                        await deleteDoc(oldDocRef);
                        
                        console.log(`Migration ${oldName} ‚Üí ${newName} erfolgreich!`);
                    }
                } catch (error) {
                    console.error(`Fehler bei Migration ${oldName} ‚Üí ${newName}:`, error);
                }
            }
            
            // Migration als abgeschlossen markieren
            await updateConfig({ migrationDone: true, dataVersion: '2.1' });
        }
        
        async function loadAllPlayerStats() {
            const promises = PLAYER_NAMES.map(async name => {
                const docSnap = await getDoc(getPlayerDocRef(name));
                const oldData = docSnap.exists() ? docSnap.data() : null;
                playerStats[name] = migratePlayerData(oldData, name);
            });
            await Promise.all(promises);
        }

        async function updateConfig(updates) {
            if (!db || !isAuthReady) return;
            AppConfig = { ...AppConfig, ...updates };
            try {
                await setDoc(getConfigDocRef(), AppConfig, { merge: true });
            } catch (error) {
                console.error("Fehler beim Speichern der Konfiguration:", error);
            }
        }
        
        async function initializeFirebase() {
            try {
                let firebaseConfig;
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (typeof __firebase_config !== 'undefined') {
                    firebaseConfig = JSON.parse(__firebase_config);
                } else {
                    firebaseConfig = {
                        apiKey: "AIzaSyDwMmGXsyG_KOM_QGUZJmGVNqq1P0VBtXk", 
                        authDomain: "handball-putzplan.firebaseapp.com",
                        projectId: "handball-putzplan",
                    };
                }

                const firebaseApp = initializeApp(firebaseConfig);
                db = getFirestore(firebaseApp);
                const auth = getAuth(firebaseApp);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                userId = auth.currentUser?.uid || 'anonymous';
                isAuthReady = true;

                await loadConfig();
                
                // NEU: Namens-Migration durchf√ºhren
                await migratePlayerNames();
                
                await loadAllPlayerStats();
                
                document.getElementById('loading-message').textContent = 'Daten geladen. Version 2.1 aktiv!';
                document.getElementById('loading-container').classList.add('hidden'); 
                
                renderPlayerList();
                updateShiftInfo();
                
            } catch (error) {
                console.error("Fehler bei der Firebase-Initialisierung:", error);
                document.getElementById('loading-message').textContent = 'Kritischer Fehler beim Starten. Siehe Konsole.';
            }
        }

        // ==========================================
        // NEUE FAIRNESS-LOGIK (Multi-Kriterien)
        // ==========================================
        
        /**
         * Berechnet den Fairness-Score f√ºr einen Spieler.
         * NIEDRIGER Score = wurde weniger belastet = sollte eher eingeteilt werden
         */
        function calculateFairnessScore(stats, targetShiftType = null, forPutzmaschine = false) {
            const w = FAIRNESS_WEIGHTS;
            let score = 0;
            
            score += stats.totalPutz * w.totalPutz;
            score -= stats.freilosCount * w.freilosCount * 0.5;
            
            const fruehSpaetDiff = Math.abs(stats.fruehPutzCount - stats.spaetPutzCount);
            score += fruehSpaetDiff * w.fruehSpaetBalance;
            
            if (targetShiftType === 'Fr√ºh') {
                score += stats.fruehPutzCount * 0.8;
                score -= stats.spaetPutzCount * 0.3;
            } else if (targetShiftType === 'Sp√§t') {
                score += stats.spaetPutzCount * 0.8;
                score -= stats.fruehPutzCount * 0.3;
            }
            
            if (forPutzmaschine) {
                const pmDiff = Math.abs(stats.putzmaschineFruehCount - stats.putzmaschineSpaetCount);
                score += pmDiff * w.pmFruehSpaetBalance;
                
                if (targetShiftType === 'Fr√ºh') {
                    score += stats.putzmaschineFruehCount * 1.5;
                } else if (targetShiftType === 'Sp√§t') {
                    score += stats.putzmaschineSpaetCount * 1.5;
                }
            }
            
            const daysSinceAssigned = stats.lastAssigned > 0 
                ? (Date.now() - stats.lastAssigned) / (1000 * 60 * 60 * 24)
                : 999;
            score -= Math.min(daysSinceAssigned, 30) * w.lastAssigned * 0.1;
            
            return score;
        }
        
        function selectByFairness(playerNames, count, targetShiftType = null, forPutzmaschine = false) {
            const playerObjects = playerNames.map(name => {
                const stats = getPlayerStats(name);
                return {
                    name,
                    stats,
                    score: calculateFairnessScore(stats, targetShiftType, forPutzmaschine)
                };
            });
            
            playerObjects.sort((a, b) => {
                if (Math.abs(a.score - b.score) < 0.01) {
                    return a.stats.lastAssigned - b.stats.lastAssigned;
                }
                return a.score - b.score;
            });
            
            return playerObjects.slice(0, count);
        }
        
        function selectPutzmaschineGlobal(availablePlayers, shiftType, excludeNames = []) {
            const candidates = availablePlayers.filter(name => !excludeNames.includes(name));
            const selected = selectByFairness(candidates, 1, shiftType, true);
            return selected.length > 0 ? selected[0] : null;
        }

        // ==========================================
        // HILFSFUNKTIONEN
        // ==========================================

        function getWeekNumber(d = new Date()) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function getPlayerStats(name) {
            return playerStats[name] || getPlayerStatsTemplate(name);
        }
        
        function updateShiftInfo() {
            const kw = getWeekNumber();
            const isEven = kw % 2 === 0;
            const donnerstagSchicht = isEven ? 'Fr√ºh' : 'Sp√§t';
            const totalTrainings = AppConfig.totalTrainings || 0;
            
            document.getElementById('shift-info').innerHTML = `
                <div class="flex flex-wrap justify-center gap-4 text-sm">
                    <span>KW: <span class="font-bold">${kw}</span> (${isEven ? 'Gerade' : 'Ungerade'})</span>
                    <span>Donnerstag: <span class="font-bold">${donnerstagSchicht}</span></span>
                    <span>Trainings: <span class="font-bold">${totalTrainings}</span></span>
                    <span class="text-indigo-700 font-semibold">v2.1</span>
                </div>
            `;
        }
        
        // ==========================================
        // RENDERING
        // ==========================================

        function renderPlayerList() {
            const listElement = document.getElementById('player-list');
            listElement.innerHTML = '';
            
            const totalTrainings = AppConfig.totalTrainings || 0;
            
            const sortedPlayers = PLAYER_NAMES.map(name => {
                const stats = getPlayerStats(name);
                const attendanceRate = totalTrainings > 0 
                    ? (stats.attendanceCount / totalTrainings) * 100 
                    : 0;
                const fruehSpaetDiff = stats.fruehPutzCount - stats.spaetPutzCount;
                return { 
                    ...stats, 
                    attendanceRate: attendanceRate.toFixed(0),
                    fruehSpaetDiff
                };
            }).sort((a, b) => a.name.localeCompare(b.name));

            sortedPlayers.forEach(player => {
                const isSelected = selectedPlayers.has(player.name);
                
                let balanceClass = 'balance-good';
                let balanceText = '‚öñÔ∏è';
                if (Math.abs(player.fruehSpaetDiff) >= 3) {
                    balanceClass = 'balance-bad';
                    balanceText = player.fruehSpaetDiff > 0 ? '‚¨ÜÔ∏èF' : '‚¨áÔ∏èS';
                } else if (Math.abs(player.fruehSpaetDiff) >= 2) {
                    balanceClass = 'balance-ok';
                    balanceText = player.fruehSpaetDiff > 0 ? '‚ÜëF' : '‚ÜìS';
                }

                const listItem = document.createElement('li');
                listItem.className = 'flex items-center justify-between p-2 rounded-lg checkbox-item';
                listItem.setAttribute('data-name', player.name);
                listItem.onclick = () => window.togglePlayer(player.name); 

                listItem.innerHTML = `
                    <div class="flex flex-col flex-1">
                        <div class="flex items-center gap-2">
                            <span class="font-medium text-gray-800">${player.name}</span>
                            <span class="text-xs ${balanceClass}" title="Fr√ºh/Sp√§t-Balance">${balanceText}</span>
                        </div>
                        <div class="text-xs text-gray-500 mt-1 flex gap-3">
                            <span title="Putzdienste">üßπ${player.totalPutz}</span>
                            <span title="Freilose">üé´${player.freilosCount}</span>
                            <span title="Anwesenheit">üìä${player.attendanceRate}%</span>
                        </div>
                    </div>
                    <div class="toggle-switch ${isSelected ? 'checked' : ''}"></div>
                `;
                listElement.appendChild(listItem);
            });
            updateUserCountInfo();
        }

        window.togglePlayer = function(name) {
            if (selectedPlayers.has(name)) {
                selectedPlayers.delete(name);
            } else {
                selectedPlayers.add(name);
            }
            renderPlayerList();
        }
        
        window.addNewPlayer = async function() {
            const nameInput = document.getElementById('new-player-name');
            const playerName = nameInput.value.trim();
            const messageDiv = document.getElementById('add-player-message');
            
            if (!playerName || PLAYER_NAMES.includes(playerName)) {
                messageDiv.textContent = "Ung√ºltiger Name oder Spieler existiert bereits.";
                messageDiv.className = "text-red-500 mt-2 text-sm";
                return;
            }
            
            PLAYER_NAMES.push(playerName); 
            playerStats[playerName] = getPlayerStatsTemplate(playerName);
            selectedPlayers.add(playerName);
            renderPlayerList();
            
            messageDiv.textContent = `'${playerName}' hinzugef√ºgt. (Tempor√§r bis Reload)`;
            messageDiv.className = "text-green-500 mt-2 text-sm";
            nameInput.value = '';
        }

        function renderMessage(container, title, message, classes) {
            container.innerHTML = `
                <div class="p-4 rounded-lg ${classes}">
                    <h3 class="font-bold">${title}</h3>
                    <p class="text-sm">${message}</p>
                </div>
            `;
            document.getElementById('whatsapp-copy-container').classList.add('hidden');
        }

        // ==========================================
        // NEU: EDITIERBARER PUTZPLAN
        // ==========================================
        
        function renderEditablePutzplan(container, cache) {
            let html = '<div class="space-y-4">';
            
            // Info-Hinweis
            html += `
                <div class="p-3 bg-amber-50 border border-amber-200 rounded-lg text-sm text-amber-800">
                    <strong>üí° Tipp:</strong> Klicke auf einen Spieler, um ihn zu √§ndern oder als Putzmaschine zu setzen.
                </div>
            `;
            
            cache.assignments.forEach((assignment, shiftIndex) => {
                const bgClass = assignment.shiftType === 'Fr√ºh' ? 'bg-blue-50' : 'bg-green-50';
                const pmStats = getPlayerStats(assignment.putzmaschine);
                const pmTotal = pmStats.putzmaschineFruehCount + pmStats.putzmaschineSpaetCount;
                
                html += `
                    <div class="p-4 rounded-xl shadow-md ${bgClass} editable-assignment" data-shift="${shiftIndex}">
                        <h3 class="text-lg font-bold text-gray-800 border-b pb-2 mb-3">
                            ${assignment.shiftName} 
                            <span class="text-sm font-normal text-gray-600">(${assignment.players.length + 1} Spieler)</span>
                        </h3>
                        
                        <div class="mb-3">
                            <span class="font-semibold text-indigo-700">Putzmaschine:</span>
                            <span class="player-chip pm" onclick="window.openPlayerSwapModal(${shiftIndex}, 'pm', '${assignment.putzmaschine}')">
                                ${assignment.putzmaschine}
                                <span class="text-xs opacity-60">(${pmTotal}x PM)</span>
                                <span class="remove-btn">‚úèÔ∏è</span>
                            </span>
                        </div>
                        
                        <div class="text-gray-700 text-sm">
                            <span class="font-medium">Crew:</span>
                            <div class="mt-1 flex flex-wrap">
                                ${assignment.players.map((player, playerIndex) => `
                                    <span class="player-chip" onclick="window.openPlayerSwapModal(${shiftIndex}, ${playerIndex}, '${player}')">
                                        ${player}
                                        <span class="remove-btn">‚úèÔ∏è</span>
                                    </span>
                                `).join('')}
                                <button onclick="window.addPlayerToShift(${shiftIndex})" class="player-chip bg-gray-200 text-gray-600 hover:bg-gray-300">
                                    + Hinzuf√ºgen
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // Freilos-Bereich
            if (cache.freilos.players.length > 0) {
                html += `
                    <div class="p-4 rounded-xl shadow-md bg-yellow-50">
                        <h3 class="text-lg font-bold text-gray-800 border-b pb-2 mb-2">
                            üé´ Freilos <span class="text-sm font-normal">(${cache.freilos.count} Spieler)</span>
                        </h3>
                        <div class="flex flex-wrap">
                            ${cache.freilos.players.map(player => `
                                <span class="player-chip bg-yellow-100 text-yellow-800">
                                    ${player}
                                </span>
                            `).join('')}
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Diese Spieler waren anwesend, m√ºssen aber nicht putzen.</p>
                    </div>
                `;
            }
            
            html += `
                </div>
                <div class="mt-4 border-t pt-4">
                    <button onclick="window.saveAssignment()" class="w-full py-3 px-6 bg-green-600 text-white font-bold text-lg rounded-xl hover:bg-green-700 transition-colors">
                        ‚úÖ Putzplan Best√§tigen & Speichern
                    </button>
                    <p class="text-xs text-center text-gray-500 mt-2">
                        Speichert Dienste, Anwesenheit und Freilose korrekt.
                    </p>
                </div>
            `;
            container.innerHTML = html;
            
            renderWhatsappExport(generateWhatsappText(cache));
        }
        
        function generateWhatsappText(cache) {
            let whatsappText = 'Putzplan - ' + new Date().toLocaleDateString('de-DE') + '\n\n';
            
            cache.assignments.forEach(assignment => {
                whatsappText += `*${assignment.shiftName}*\n`;
                whatsappText += `Maschine: ${assignment.putzmaschine}\n`;
                whatsappText += `Crew: ${assignment.players.join(', ')}\n\n`;
            });
            
            if (cache.freilos.players.length > 0) {
                whatsappText += `*Freilos:*\n${cache.freilos.players.join(', ')}\n`;
            }
            
            return whatsappText;
        }
        
        // Modal f√ºr Spieler-Austausch
        window.openPlayerSwapModal = function(shiftIndex, playerIndex, currentPlayer) {
            const modal = document.getElementById('swap-modal');
            const content = document.getElementById('swap-modal-content');
            
            const assignment = assignmentCache.assignments[shiftIndex];
            const isPM = playerIndex === 'pm';
            
            // Freilos-Spieler
            const freilosPlayers = assignmentCache.freilos.players;
            
            // NEU: Crew-Mitglieder (f√ºr PM-Tausch)
            const crewPlayers = assignment.players.filter(p => p !== currentPlayer);
            
            content.innerHTML = `
                <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">
                    ${isPM ? 'üîß Putzmaschine' : 'üë§ Crew-Mitglied'} √§ndern
                </h2>
                <p class="text-sm text-gray-600 mb-4">
                    Aktuell: <strong>${currentPlayer}</strong>
                </p>
                
                <div class="space-y-2 max-h-60 overflow-y-auto">
                    ${isPM ? `
                        <p class="text-xs font-semibold text-gray-500 uppercase">Crew-Mitglied zur Putzmaschine machen:</p>
                        ${crewPlayers.length > 0 ? crewPlayers.map(player => {
                            const stats = getPlayerStats(player);
                            const pmCount = stats.putzmaschineFruehCount + stats.putzmaschineSpaetCount;
                            return `
                                <button onclick="window.swapPMWithCrew(${shiftIndex}, '${currentPlayer}', '${player}')" 
                                    class="w-full text-left p-2 rounded-lg hover:bg-indigo-50 border border-gray-200 flex justify-between items-center">
                                    <span>${player}</span>
                                    <span class="text-xs text-gray-500">üßπ${stats.totalPutz} | PM:${pmCount}</span>
                                </button>
                            `;
                        }).join('') : '<p class="text-gray-400 text-sm italic">Keine Crew-Mitglieder</p>'}
                    ` : `
                        <p class="text-xs font-semibold text-gray-500 uppercase">Mit anderem Crew-Mitglied tauschen:</p>
                        ${crewPlayers.length > 0 ? crewPlayers.map(player => {
                            const stats = getPlayerStats(player);
                            return `
                                <button onclick="window.swapCrewMembers(${shiftIndex}, ${playerIndex}, '${currentPlayer}', '${player}')" 
                                    class="w-full text-left p-2 rounded-lg hover:bg-indigo-50 border border-gray-200 flex justify-between items-center">
                                    <span>${player}</span>
                                    <span class="text-xs text-gray-500">üßπ${stats.totalPutz}</span>
                                </button>
                            `;
                        }).join('') : '<p class="text-gray-400 text-sm italic">Keine weiteren Crew-Mitglieder</p>'}
                        
                        <p class="text-xs font-semibold text-gray-500 uppercase mt-4">Zur Putzmaschine machen:</p>
                        <button onclick="window.promoteToRM(${shiftIndex}, ${playerIndex}, '${currentPlayer}')" 
                            class="w-full text-left p-2 rounded-lg hover:bg-amber-50 border border-amber-300 flex justify-between items-center">
                            <span>‚¨ÜÔ∏è ${currentPlayer} zur Putzmaschine</span>
                            <span class="text-xs text-amber-600">(${assignment.putzmaschine} wird Crew)</span>
                        </button>
                    `}
                    
                    ${freilosPlayers.length > 0 ? `
                        <p class="text-xs font-semibold text-gray-500 uppercase mt-4">Aus Freilos holen:</p>
                        ${freilosPlayers.map(player => {
                            const stats = getPlayerStats(player);
                            const pmCount = stats.putzmaschineFruehCount + stats.putzmaschineSpaetCount;
                            return `
                                <button onclick="window.swapPlayerFromFreilos(${shiftIndex}, '${playerIndex}', '${currentPlayer}', '${player}')" 
                                    class="w-full text-left p-2 rounded-lg hover:bg-yellow-50 border border-yellow-200 flex justify-between items-center">
                                    <span>${player} <span class="text-yellow-600 text-xs">(Freilos)</span></span>
                                    <span class="text-xs text-gray-500">üßπ${stats.totalPutz} | PM:${pmCount}</span>
                                </button>
                            `;
                        }).join('')}
                    ` : ''}
                </div>
                
                <div class="flex justify-between mt-4 pt-4 border-t">
                    ${!isPM ? `
                        <button onclick="window.removePlayerFromShift(${shiftIndex}, ${playerIndex}, '${currentPlayer}')" 
                            class="text-red-600 hover:text-red-800 text-sm">
                            üóëÔ∏è Zu Freilos verschieben
                        </button>
                    ` : '<div></div>'}
                    <button onclick="document.getElementById('swap-modal').classList.add('hidden')" 
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">
                        Abbrechen
                    </button>
                </div>
            `;
            modal.classList.remove('hidden');
        }
        
        // NEU: PM mit Crew-Mitglied tauschen
        window.swapPMWithCrew = function(shiftIndex, currentPM, newPM) {
            const assignment = assignmentCache.assignments[shiftIndex];
            
            // Neuen PM aus Crew entfernen
            assignment.players = assignment.players.filter(p => p !== newPM);
            // Alten PM zur Crew hinzuf√ºgen
            assignment.players.push(currentPM);
            // Neuen PM setzen
            assignment.putzmaschine = newPM;
            
            document.getElementById('swap-modal').classList.add('hidden');
            renderEditablePutzplan(document.getElementById('putzplan-result'), assignmentCache);
        }
        
        // NEU: Crew-Mitglied zur Putzmaschine bef√∂rdern
        window.promoteToRM = function(shiftIndex, playerIndex, playerName) {
            const assignment = assignmentCache.assignments[shiftIndex];
            const oldPM = assignment.putzmaschine;
            
            // Spieler aus Crew entfernen
            assignment.players.splice(playerIndex, 1);
            // Alten PM zur Crew hinzuf√ºgen
            assignment.players.push(oldPM);
            // Neuen PM setzen
            assignment.putzmaschine = playerName;
            
            document.getElementById('swap-modal').classList.add('hidden');
            renderEditablePutzplan(document.getElementById('putzplan-result'), assignmentCache);
        }
        
        // NEU: Zwei Crew-Mitglieder tauschen (Positionen)
        window.swapCrewMembers = function(shiftIndex, playerIndex, player1, player2) {
            // Eigentlich nur visuelle Neuanordnung, aber f√ºr Konsistenz
            document.getElementById('swap-modal').classList.add('hidden');
            renderEditablePutzplan(document.getElementById('putzplan-result'), assignmentCache);
        }
        
        // Wird nicht mehr ben√∂tigt - durch swapPMWithCrew ersetzt
        
        window.swapPlayerFromFreilos = function(shiftIndex, playerIndex, oldPlayer, newPlayer) {
            const assignment = assignmentCache.assignments[shiftIndex];
            
            // Spieler aus Freilos entfernen
            assignmentCache.freilos.players = assignmentCache.freilos.players.filter(p => p !== newPlayer);
            assignmentCache.freilos.count = assignmentCache.freilos.players.length;
            
            if (playerIndex === 'pm') {
                // Alten PM zu Freilos
                assignmentCache.freilos.players.push(assignment.putzmaschine);
                assignmentCache.freilos.count++;
                assignment.putzmaschine = newPlayer;
            } else {
                // Alten Spieler zu Freilos
                assignmentCache.freilos.players.push(oldPlayer);
                assignmentCache.freilos.count++;
                assignment.players[playerIndex] = newPlayer;
            }
            
            document.getElementById('swap-modal').classList.add('hidden');
            renderEditablePutzplan(document.getElementById('putzplan-result'), assignmentCache);
        }
        
        window.removePlayerFromShift = function(shiftIndex, playerIndex, playerName) {
            const assignment = assignmentCache.assignments[shiftIndex];
            
            // Spieler aus Crew entfernen
            assignment.players.splice(playerIndex, 1);
            
            // Zu Freilos hinzuf√ºgen
            assignmentCache.freilos.players.push(playerName);
            assignmentCache.freilos.count++;
            
            document.getElementById('swap-modal').classList.add('hidden');
            renderEditablePutzplan(document.getElementById('putzplan-result'), assignmentCache);
        }
        
        window.addPlayerToShift = function(shiftIndex) {
            const assignment = assignmentCache.assignments[shiftIndex];
            const modal = document.getElementById('swap-modal');
            const content = document.getElementById('swap-modal-content');
            
            // Verf√ºgbare Spieler aus Freilos
            const freilosPlayers = assignmentCache.freilos.players;
            
            content.innerHTML = `
                <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">
                    ‚ûï Spieler zur ${assignment.shiftName} hinzuf√ºgen
                </h2>
                
                <div class="space-y-2 max-h-60 overflow-y-auto">
                    ${freilosPlayers.length > 0 ? freilosPlayers.map(player => {
                        const stats = getPlayerStats(player);
                        return `
                            <button onclick="window.addFromFreilos(${shiftIndex}, '${player}')" 
                                class="w-full text-left p-2 rounded-lg hover:bg-indigo-50 border border-gray-200 flex justify-between items-center">
                                <span>${player}</span>
                                <span class="text-xs text-gray-500">üßπ${stats.totalPutz}</span>
                            </button>
                        `;
                    }).join('') : '<p class="text-gray-400 text-sm">Keine Freilos-Spieler verf√ºgbar</p>'}
                </div>
                
                <div class="flex justify-end mt-4 pt-4 border-t">
                    <button onclick="document.getElementById('swap-modal').classList.add('hidden')" 
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">
                        Abbrechen
                    </button>
                </div>
            `;
            modal.classList.remove('hidden');
        }
        
        window.addFromFreilos = function(shiftIndex, playerName) {
            const assignment = assignmentCache.assignments[shiftIndex];
            
            // Aus Freilos entfernen
            assignmentCache.freilos.players = assignmentCache.freilos.players.filter(p => p !== playerName);
            assignmentCache.freilos.count--;
            
            // Zur Crew hinzuf√ºgen
            assignment.players.push(playerName);
            
            document.getElementById('swap-modal').classList.add('hidden');
            renderEditablePutzplan(document.getElementById('putzplan-result'), assignmentCache);
        }
        
        // ==========================================
        // PUTZPLAN GENERIERUNG
        // ==========================================

        window.generatePutzplan = function() {
            try {
                const availablePlayers = Array.from(selectedPlayers);
                const variant = document.querySelector('input[name="variant"]:checked').value;
                const resultDiv = document.getElementById('putzplan-result');
                resultDiv.innerHTML = '';
                document.getElementById('whatsapp-copy-container').classList.add('hidden');
                assignmentCache = null; 

                if (availablePlayers.length < 1) {
                    renderMessage(resultDiv, 'Keine Spieler ausgew√§hlt', 
                        'Bitte w√§hle mindestens einen Spieler aus.', 'bg-red-100 text-red-800');
                    return;
                }
                
                let assignments = [];
                let freilosNames = [];
                
                if (variant === '1') {
                    const shiftType = AppConfig.nextPutzmaschineType || 'Fr√ºh';
                    const playersNeeded = Math.min(availablePlayers.length, PLAYERS_PER_UNIT);
                    
                    const pmSelection = selectPutzmaschineGlobal(availablePlayers, shiftType);
                    if (!pmSelection) {
                        renderMessage(resultDiv, 'Fehler', 'Keine Spieler verf√ºgbar.', 'bg-red-100 text-red-800');
                        return;
                    }
                    const putzmaschine = pmSelection.name;
                    
                    const remainingPlayers = availablePlayers.filter(n => n !== putzmaschine);
                    const crewNeeded = playersNeeded - 1;
                    const crewSelection = selectByFairness(remainingPlayers, crewNeeded, shiftType, false);
                    const crewNames = crewSelection.map(p => p.name);
                    
                    const allAssigned = [putzmaschine, ...crewNames];
                    freilosNames = availablePlayers.filter(n => !allAssigned.includes(n));
                    
                    assignments.push({
                        shiftName: `Putzdienst (${shiftType})`,
                        shiftType: shiftType,
                        players: crewNames,
                        putzmaschine: putzmaschine,
                    });
                    
                    assignmentCache = {
                        assignments,
                        freilos: { players: freilosNames, count: freilosNames.length },
                        nextPutzmaschineType: shiftType === 'Fr√ºh' ? 'Sp√§t' : 'Fr√ºh',
                        allPresentPlayers: availablePlayers
                    };

                } else if (variant === '2') {
                    const totalNeeded = 2 * PLAYERS_PER_UNIT;
                    
                    if (availablePlayers.length < 2) {
                        renderMessage(resultDiv, 'Zu wenig Spieler', 
                            'F√ºr 2 Schichten werden mindestens 2 Spieler ben√∂tigt.', 'bg-red-100 text-red-800');
                        return;
                    }
                    
                    const playersToAssign = Math.min(availablePlayers.length, totalNeeded);
                    
                    const sizePerShift = Math.floor(playersToAssign / 2);
                    const remainder = playersToAssign % 2;
                    const shift1Size = sizePerShift + remainder;
                    const shift2Size = sizePerShift;
                    
                    const pm1Selection = selectPutzmaschineGlobal(availablePlayers, 'Fr√ºh');
                    const pm1 = pm1Selection ? pm1Selection.name : availablePlayers[0];
                    
                    const pm2Selection = selectPutzmaschineGlobal(availablePlayers, 'Sp√§t', [pm1]);
                    const pm2 = pm2Selection ? pm2Selection.name : availablePlayers.find(n => n !== pm1);
                    
                    const remainingPlayers = availablePlayers.filter(n => n !== pm1 && n !== pm2);
                    
                    const crew1Needed = shift1Size - 1;
                    const crew1Selection = selectByFairness(remainingPlayers, crew1Needed, 'Fr√ºh', false);
                    const crew1Names = crew1Selection.map(p => p.name);
                    
                    const crew2Names = remainingPlayers.filter(n => !crew1Names.includes(n)).slice(0, shift2Size - 1);
                    
                    const allAssigned = [pm1, pm2, ...crew1Names, ...crew2Names];
                    freilosNames = availablePlayers.filter(n => !allAssigned.includes(n));
                    
                    assignments.push({
                        shiftName: 'Schicht 1 (Fr√ºh)',
                        shiftType: 'Fr√ºh',
                        players: crew1Names,
                        putzmaschine: pm1,
                    });
                    
                    if (pm2 || crew2Names.length > 0) {
                        assignments.push({
                            shiftName: 'Schicht 2 (Sp√§t)',
                            shiftType: 'Sp√§t',
                            players: crew2Names,
                            putzmaschine: pm2,
                        });
                    }
                    
                    assignmentCache = {
                        assignments,
                        freilos: { players: freilosNames, count: freilosNames.length },
                        nextPutzmaschineType: AppConfig.nextPutzmaschineType,
                        allPresentPlayers: availablePlayers
                    };
                }
                
                // NEU: Editierbaren Putzplan rendern
                renderEditablePutzplan(resultDiv, assignmentCache);

            } catch (error) {
                console.error("KRITISCHER FEHLER:", error);
                renderMessage(document.getElementById('putzplan-result'), 
                    'Kritischer Fehler', `${error.message}`, 'bg-red-100 text-red-800');
            }
        }

        // ==========================================
        // SPEICHERN
        // ==========================================

        window.saveAssignment = async function() {
            if (!assignmentCache || !db) {
                renderMessage(document.getElementById('putzplan-result'), 
                    'Fehler', 'Datenbank nicht bereit oder Putzplan fehlt.', 'bg-red-100 text-red-800');
                return;
            }
            
            const now = Date.now();
            AppConfig.totalTrainings += 1;
            
            await updateConfig({ 
                totalTrainings: AppConfig.totalTrainings, 
                nextPutzmaschineType: assignmentCache.nextPutzmaschineType 
            });

            const promises = [];
            
            assignmentCache.assignments.forEach(assignment => {
                const shiftKey = assignment.shiftType === 'Fr√ºh' ? 'fruehPutzCount' : 'spaetPutzCount';
                const pmKey = assignment.shiftType === 'Fr√ºh' ? 'putzmaschineFruehCount' : 'putzmaschineSpaetCount';
                
                const allAssigned = [assignment.putzmaschine, ...assignment.players];

                allAssigned.forEach(name => {
                    const stats = getPlayerStats(name);
                    const isPM = name === assignment.putzmaschine;
                    
                    const updates = {
                        totalPutz: (stats.totalPutz || 0) + 1,
                        attendanceCount: (stats.attendanceCount || 0) + 1,
                        lastAssigned: now,
                        [shiftKey]: (stats[shiftKey] || 0) + 1
                    };
                    if (isPM) {
                        updates[pmKey] = (stats[pmKey] || 0) + 1;
                    }
                    
                    playerStats[name] = { ...stats, ...updates };
                    promises.push(setDoc(getPlayerDocRef(name), updates, { merge: true }));
                });
            });

            assignmentCache.freilos.players.forEach(name => {
                const stats = getPlayerStats(name);
                const updates = {
                    freilosCount: (stats.freilosCount || 0) + 1,
                    attendanceCount: (stats.attendanceCount || 0) + 1,
                    lastAssigned: now
                };
                
                playerStats[name] = { ...stats, ...updates };
                promises.push(setDoc(getPlayerDocRef(name), updates, { merge: true }));
            });
            
            try {
                await Promise.all(promises);
                document.getElementById('putzplan-result').innerHTML = `
                    <div class="p-4 rounded-lg bg-green-100 text-green-800">
                        <h3 class="font-bold">‚úÖ Erfolgreich gespeichert!</h3>
                        <p class="text-sm mt-1">
                            ${assignmentCache.assignments.reduce((sum, a) => sum + a.players.length + 1, 0)} Putzdienste und 
                            ${assignmentCache.freilos.count} Freilose wurden korrekt gez√§hlt.
                        </p>
                    </div>
                `;
                assignmentCache = null;
                renderPlayerList();
                updateShiftInfo();
            } catch (e) {
                console.error("Speicherfehler:", e);
                renderMessage(document.getElementById('putzplan-result'), 
                    'Speicherfehler', 'Fehler beim Cloud-Speichern.', 'bg-red-100 text-red-800');
            }
        }
        
        // ==========================================
        // NEU: NACHREICHEN-FUNKTION
        // ==========================================
        
        window.toggleNachreichenModal = function() {
            const modal = document.getElementById('nachreichen-modal');
            modal.classList.toggle('hidden');
            
            if (!modal.classList.contains('hidden')) {
                renderNachreichenForm();
            }
        }
        
        function renderNachreichenForm() {
            const content = document.getElementById('nachreichen-content');
            
            content.innerHTML = `
                <div class="space-y-4">
                    <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-800">
                        <strong>‚ÑπÔ∏è Info:</strong> Hier kannst du einen Putzdienst nachtr√§glich eintragen, 
                        z.B. wenn die Teams sich selbst gebildet haben.
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Schichttyp</label>
                        <select id="nachreichen-shift" class="w-full p-2 border rounded-lg">
                            <option value="Fr√ºh">Fr√ºh</option>
                            <option value="Sp√§t">Sp√§t</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Putzmaschine</label>
                        <select id="nachreichen-pm" class="w-full p-2 border rounded-lg">
                            <option value="">-- Bitte w√§hlen --</option>
                            ${PLAYER_NAMES.map(name => `<option value="${name}">${name}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Crew (mehrere ausw√§hlen)</label>
                        <div class="max-h-40 overflow-y-auto border rounded-lg p-2 space-y-1">
                            ${PLAYER_NAMES.map(name => `
                                <label class="flex items-center gap-2 p-1 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" class="nachreichen-crew" value="${name}">
                                    <span>${name}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Freilose (optional)</label>
                        <div class="max-h-32 overflow-y-auto border rounded-lg p-2 space-y-1">
                            ${PLAYER_NAMES.map(name => `
                                <label class="flex items-center gap-2 p-1 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" class="nachreichen-freilos" value="${name}">
                                    <span>${name}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="nachreichen-count-training" checked>
                        <label for="nachreichen-count-training" class="text-sm text-gray-700">
                            Als Training z√§hlen (+1 zu Gesamtzahl)
                        </label>
                    </div>
                </div>
            `;
        }
        
        window.saveNachreichen = async function() {
            const shiftType = document.getElementById('nachreichen-shift').value;
            const pm = document.getElementById('nachreichen-pm').value;
            const crewCheckboxes = document.querySelectorAll('.nachreichen-crew:checked');
            const freilosCheckboxes = document.querySelectorAll('.nachreichen-freilos:checked');
            const countAsTraining = document.getElementById('nachreichen-count-training').checked;
            
            if (!pm) {
                alert('Bitte Putzmaschine ausw√§hlen!');
                return;
            }
            
            const crew = Array.from(crewCheckboxes).map(cb => cb.value).filter(n => n !== pm);
            const freilos = Array.from(freilosCheckboxes).map(cb => cb.value).filter(n => n !== pm && !crew.includes(n));
            
            if (crew.length === 0) {
                alert('Bitte mindestens ein Crew-Mitglied ausw√§hlen!');
                return;
            }
            
            const now = Date.now();
            const shiftKey = shiftType === 'Fr√ºh' ? 'fruehPutzCount' : 'spaetPutzCount';
            const pmKey = shiftType === 'Fr√ºh' ? 'putzmaschineFruehCount' : 'putzmaschineSpaetCount';
            
            const promises = [];
            
            // Training z√§hlen
            if (countAsTraining) {
                AppConfig.totalTrainings += 1;
                promises.push(updateConfig({ totalTrainings: AppConfig.totalTrainings }));
            }
            
            // Putzmaschine speichern
            const pmStats = getPlayerStats(pm);
            const pmUpdates = {
                totalPutz: (pmStats.totalPutz || 0) + 1,
                attendanceCount: (pmStats.attendanceCount || 0) + 1,
                lastAssigned: now,
                [shiftKey]: (pmStats[shiftKey] || 0) + 1,
                [pmKey]: (pmStats[pmKey] || 0) + 1
            };
            playerStats[pm] = { ...pmStats, ...pmUpdates };
            promises.push(setDoc(getPlayerDocRef(pm), pmUpdates, { merge: true }));
            
            // Crew speichern
            crew.forEach(name => {
                const stats = getPlayerStats(name);
                const updates = {
                    totalPutz: (stats.totalPutz || 0) + 1,
                    attendanceCount: (stats.attendanceCount || 0) + 1,
                    lastAssigned: now,
                    [shiftKey]: (stats[shiftKey] || 0) + 1
                };
                playerStats[name] = { ...stats, ...updates };
                promises.push(setDoc(getPlayerDocRef(name), updates, { merge: true }));
            });
            
            // Freilose speichern
            freilos.forEach(name => {
                const stats = getPlayerStats(name);
                const updates = {
                    freilosCount: (stats.freilosCount || 0) + 1,
                    attendanceCount: (stats.attendanceCount || 0) + 1,
                    lastAssigned: now
                };
                playerStats[name] = { ...stats, ...updates };
                promises.push(setDoc(getPlayerDocRef(name), updates, { merge: true }));
            });
            
            try {
                await Promise.all(promises);
                
                alert(`‚úÖ Nachgereicht!\n\nPutzmaschine: ${pm}\nCrew: ${crew.join(', ')}\nFreilose: ${freilos.length > 0 ? freilos.join(', ') : 'keine'}`);
                
                window.toggleNachreichenModal();
                renderPlayerList();
                updateShiftInfo();
            } catch (e) {
                console.error("Fehler beim Nachreichen:", e);
                alert("Fehler beim Speichern!");
            }
        }
        
        // ==========================================
        // CSV EXPORT
        // ==========================================
        
        window.exportStatsToCSV = function() {
            if (PLAYER_NAMES.length === 0) {
                alert('Keine Spielerdaten zum Exportieren.');
                return;
            }

            const totalTrainings = AppConfig.totalTrainings || 0;
            let csvContent = "Spieler;Anwesend;Geputzt;Freilose;Anwesenheit_%;Frueh;Spaet;PM_Frueh;PM_Spaet;Frueh_Spaet_Diff\n";
            
            PLAYER_NAMES.forEach(name => {
                const stats = getPlayerStats(name);
                const attendance = totalTrainings > 0 ? (stats.attendanceCount / totalTrainings) * 100 : 0;
                const fruehSpaetDiff = stats.fruehPutzCount - stats.spaetPutzCount;

                const row = [
                    stats.name,
                    stats.attendanceCount,
                    stats.totalPutz,
                    stats.freilosCount,
                    attendance.toFixed(1),
                    stats.fruehPutzCount,
                    stats.spaetPutzCount,
                    stats.putzmaschineFruehCount,
                    stats.putzmaschineSpaetCount,
                    fruehSpaetDiff
                ];
                csvContent += row.join(";") + "\n";
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const filename = `Handball_Putzplan_v2.1_${new Date().toISOString().slice(0, 10)}.csv`;
            
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();

            alert('CSV exportiert!');
        }

        // ==========================================
        // MODALS & UI
        // ==========================================

        function renderWhatsappExport(text) {
            const container = document.getElementById('whatsapp-copy-container');
            container.innerHTML = `
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <h4 class="font-semibold text-gray-700 mb-2">üì± WhatsApp-Format</h4>
                    <textarea id="whatsapp-output" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50 text-xs" readonly>${text}</textarea>
                    <button onclick="window.copyToClipboard('whatsapp-output')" class="mt-2 w-full py-2 bg-indigo-500 text-white font-medium rounded-lg hover:bg-indigo-600 text-sm">
                        üìã Kopieren
                    </button>
                    <p id="copy-status" class="text-xs text-green-600 mt-1 hidden">Kopiert!</p>
                </div>
            `;
            container.classList.remove('hidden');
        }

        window.copyToClipboard = function(elementId) {
            const copyText = document.getElementById(elementId);
            copyText.select();
            document.execCommand('copy');
            
            const status = document.getElementById('copy-status');
            status.classList.remove('hidden');
            setTimeout(() => status.classList.add('hidden'), 2000);
        }
        
        window.showPlayerDetails = function(playerName) {
            const stats = getPlayerStats(playerName);
            const totalTrainings = AppConfig.totalTrainings || 0;
            const attendanceRate = totalTrainings > 0 ? (stats.attendanceCount / totalTrainings) * 100 : 0;
            const fruehSpaetDiff = stats.fruehPutzCount - stats.spaetPutzCount;
            const pmDiff = stats.putzmaschineFruehCount - stats.putzmaschineSpaetCount;
            
            const fairnessScore = calculateFairnessScore(stats).toFixed(2);
            
            const modal = document.getElementById('details-modal');
            const content = document.getElementById('details-modal-content');

            content.innerHTML = `
                <div class="flex justify-between items-center border-b pb-2 mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">${playerName}</h2>
                    <button onclick="window.enableEditMode('${playerName}')" class="text-xs bg-indigo-100 hover:bg-indigo-200 text-indigo-700 font-semibold py-1 px-2 rounded">
                        ‚úèÔ∏è Bearbeiten
                    </button>
                </div>
                
                <div class="mb-4 p-3 bg-indigo-50 rounded-lg">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-medium text-indigo-700">Fairness-Score</span>
                        <span class="text-lg font-bold text-indigo-900">${fairnessScore}</span>
                    </div>
                    <p class="text-xs text-indigo-600 mt-1">Niedriger = weniger belastet = wird eher eingeteilt</p>
                </div>
                
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <p class="text-gray-600">Anwesend</p>
                        <p class="text-xl font-bold">${stats.attendanceCount}x</p>
                        <p class="text-xs text-gray-500">${attendanceRate.toFixed(0)}% Quote</p>
                    </div>
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <p class="text-gray-600">Geputzt</p>
                        <p class="text-xl font-bold text-indigo-600">${stats.totalPutz}x</p>
                    </div>
                    <div class="p-3 bg-yellow-50 rounded-lg">
                        <p class="text-gray-600">Freilose</p>
                        <p class="text-xl font-bold text-yellow-600">${stats.freilosCount}x</p>
                    </div>
                    <div class="p-3 ${Math.abs(fruehSpaetDiff) >= 2 ? 'bg-red-50' : 'bg-green-50'} rounded-lg">
                        <p class="text-gray-600">Fr√ºh/Sp√§t-Balance</p>
                        <p class="text-xl font-bold">${stats.fruehPutzCount}/${stats.spaetPutzCount}</p>
                        <p class="text-xs ${Math.abs(fruehSpaetDiff) >= 2 ? 'text-red-600' : 'text-green-600'}">
                            Diff: ${fruehSpaetDiff > 0 ? '+' : ''}${fruehSpaetDiff}
                        </p>
                    </div>
                </div>
                
                <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                    <p class="font-medium text-gray-700 mb-2">Putzmaschine</p>
                    <div class="flex justify-between text-sm">
                        <span>Fr√ºh: <strong>${stats.putzmaschineFruehCount}x</strong></span>
                        <span>Sp√§t: <strong>${stats.putzmaschineSpaetCount}x</strong></span>
                        <span class="${Math.abs(pmDiff) >= 2 ? 'text-red-600' : 'text-green-600'}">
                            Diff: ${pmDiff > 0 ? '+' : ''}${pmDiff}
                        </span>
                    </div>
                </div>
            `;
            modal.classList.remove('hidden');
        }

        window.enableEditMode = function(playerName) {
            const stats = getPlayerStats(playerName);
            const content = document.getElementById('details-modal-content');
            
            content.innerHTML = `
                <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">‚úèÔ∏è ${playerName} bearbeiten</h2>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-medium text-gray-700">Anwesenheit</label>
                        <input type="number" id="edit-attendance" value="${stats.attendanceCount}" class="mt-1 w-full border rounded p-2">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700">Geputzt</label>
                        <input type="number" id="edit-totalPutz" value="${stats.totalPutz}" class="mt-1 w-full border rounded p-2">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700">Freilose</label>
                        <input type="number" id="edit-freilos" value="${stats.freilosCount}" class="mt-1 w-full border rounded p-2">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700">Fr√ºh</label>
                        <input type="number" id="edit-frueh" value="${stats.fruehPutzCount}" class="mt-1 w-full border rounded p-2">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700">Sp√§t</label>
                        <input type="number" id="edit-spaet" value="${stats.spaetPutzCount}" class="mt-1 w-full border rounded p-2">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700">PM Fr√ºh</label>
                        <input type="number" id="edit-pmFrueh" value="${stats.putzmaschineFruehCount}" class="mt-1 w-full border rounded p-2">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700">PM Sp√§t</label>
                        <input type="number" id="edit-pmSpaet" value="${stats.putzmaschineSpaetCount}" class="mt-1 w-full border rounded p-2">
                    </div>
                </div>
                <div class="flex justify-end gap-2 mt-4 pt-4 border-t">
                    <button onclick="window.showPlayerDetails('${playerName}')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">Abbrechen</button>
                    <button onclick="window.saveEditedStats('${playerName}')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Speichern</button>
                </div>
            `;
        }

        window.saveEditedStats = async function(playerName) {
            const updates = {
                attendanceCount: parseInt(document.getElementById('edit-attendance').value) || 0,
                totalPutz: parseInt(document.getElementById('edit-totalPutz').value) || 0,
                freilosCount: parseInt(document.getElementById('edit-freilos').value) || 0,
                fruehPutzCount: parseInt(document.getElementById('edit-frueh').value) || 0,
                spaetPutzCount: parseInt(document.getElementById('edit-spaet').value) || 0,
                putzmaschineFruehCount: parseInt(document.getElementById('edit-pmFrueh').value) || 0,
                putzmaschineSpaetCount: parseInt(document.getElementById('edit-pmSpaet').value) || 0,
            };

            try {
                await setDoc(getPlayerDocRef(playerName), updates, { merge: true });
                playerStats[playerName] = { ...playerStats[playerName], ...updates };
                
                alert('Gespeichert!');
                window.showPlayerDetails(playerName);
                renderPlayerList();
            } catch (e) {
                console.error("Fehler:", e);
                alert("Speicherfehler!");
            }
        }
        
        window.editTotalTrainings = function() {
            const currentTotal = AppConfig.totalTrainings || 0;
            const newTotal = prompt("Gesamtzahl der Trainings:", currentTotal);
            
            if (newTotal !== null && !isNaN(newTotal) && parseInt(newTotal) >= 0) {
                updateConfig({ totalTrainings: parseInt(newTotal) }).then(() => {
                    updateShiftInfo();
                    renderStatsCards();
                    renderPlayerList();
                    alert("Aktualisiert!");
                });
            }
        }

        window.toggleStatsModal = function() {
            const modal = document.getElementById('stats-modal');
            modal.classList.toggle('hidden');
            if (!modal.classList.contains('hidden')) {
                renderStatsCards();
            }
        }
        
        function renderStatsCards() {
            const container = document.getElementById('stats-card-container');
            container.innerHTML = `
                <div class="col-span-full mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg flex justify-between items-center">
                    <span class="text-sm font-semibold text-yellow-800">Trainings gesamt: ${AppConfig.totalTrainings || 0}</span>
                    <button onclick="window.editTotalTrainings()" class="text-xs bg-white border border-yellow-300 text-yellow-800 px-2 py-1 rounded hover:bg-yellow-100">
                        Korrigieren
                    </button>
                </div>
            `;
            
            const sortedPlayers = PLAYER_NAMES.map(name => {
                const stats = getPlayerStats(name);
                const fairnessScore = calculateFairnessScore(stats);
                return { ...stats, fairnessScore };
            }).sort((a, b) => b.totalPutz - a.totalPutz);

            sortedPlayers.forEach((player, index) => {
                const rank = index + 1;
                const pmTotal = player.putzmaschineFruehCount + player.putzmaschineSpaetCount;
                const balance = player.fruehPutzCount - player.spaetPutzCount;
                const balanceClass = Math.abs(balance) >= 2 ? 'text-red-600' : 'text-green-600';
                
                const card = document.createElement('div');
                card.className = 'player-stat-card container-card p-3 text-center';
                card.onclick = () => window.showPlayerDetails(player.name);

                card.innerHTML = `
                    <div class="text-lg font-bold text-indigo-700">${rank}. ${player.name}</div>
                    <p class="text-3xl font-bold my-1">${player.totalPutz}x</p>
                    <p class="text-xs text-gray-500">Putzdienste</p>
                    <div class="mt-2 pt-2 border-t text-xs grid grid-cols-2 gap-1">
                        <span>üìä ${player.attendanceCount}x da</span>
                        <span>üé´ ${player.freilosCount}x frei</span>
                        <span class="${balanceClass}">F/S: ${player.fruehPutzCount}/${player.spaetPutzCount}</span>
                        <span>PM: ${pmTotal}x</span>
                    </div>
                    <div class="mt-2 text-xs text-indigo-600">
                        Score: ${player.fairnessScore.toFixed(1)}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        window.toggleResetModal = function() {
            document.getElementById('reset-modal').classList.toggle('hidden');
        }

        window.resetAllStats = async function() {
            if (!db) {
                alert('Datenbank nicht verbunden.');
                window.toggleResetModal();
                return;
            }
            
            const promises = [];
            promises.push(updateConfig({ nextPutzmaschineType: 'Fr√ºh', totalTrainings: 0 }));
            PLAYER_NAMES.forEach(name => {
                promises.push(setDoc(getPlayerDocRef(name), getPlayerStatsTemplate(name)));
            });

            try {
                await Promise.all(promises);
                window.toggleResetModal(); 
                document.getElementById('putzplan-result').innerHTML = `
                    <div class="p-4 rounded-lg bg-red-100 text-red-800">
                        <h3 class="font-bold">üóëÔ∏è Alle Statistiken gel√∂scht!</h3>
                        <p class="text-sm">Neue Saison kann beginnen.</p>
                    </div>
                `;
                await loadConfig();
                await loadAllPlayerStats();
                renderPlayerList();
                updateShiftInfo();
            } catch (e) {
                window.toggleResetModal();
                alert('Fehler beim L√∂schen.');
            }
        }
        
        function updateUserCountInfo() {
            const count = selectedPlayers.size;
            document.getElementById('user-count-info').innerHTML = `
                <span class="font-bold">${count}</span> Spieler ausgew√§hlt
            `;
            document.getElementById('user-count-info').classList.remove('hidden');
        }

        window.addEventListener('load', initializeFirebase);

    </script>
</head>
<body class="p-4 sm:p-6 min-h-screen">

    <div id="loading-container" class="fixed inset-0 bg-gray-50 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
            <p id="loading-message" class="text-lg font-semibold text-indigo-600">Lade Daten aus der Cloud...</p>
        </div>
    </div>

    <div class="max-w-5xl mx-auto space-y-6">
        <header class="text-center">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-2">üßπ Handball Putzplan</h1>
            <p class="text-gray-600">Multi-Kriterien Fairness-System</p>
            <div id="shift-info" class="mt-3 p-3 bg-indigo-100 text-indigo-800 rounded-lg text-sm"></div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <!-- Spieler-Auswahl -->
            <div class="lg:col-span-1 container-card p-4">
                <h2 class="text-xl font-semibold text-gray-800 mb-3 border-b pb-2">üë• Anwesende Spieler</h2>
                <div class="h-72 overflow-y-auto pr-2 mb-3">
                    <ul id="player-list" class="space-y-1"></ul>
                </div>
                <div class="pt-3 border-t">
                    <div class="flex gap-2">
                        <input type="text" id="new-player-name" placeholder="Neuer Spieler" class="flex-1 p-2 border rounded-lg text-sm">
                        <button onclick="window.addNewPlayer()" class="py-2 px-3 bg-indigo-500 text-white font-medium rounded-lg hover:bg-indigo-600 text-sm">+</button>
                    </div>
                    <p id="add-player-message" class="text-xs mt-1"></p>
                </div>
            </div>

            <!-- Konfiguration -->
            <div class="lg:col-span-1 container-card p-4 flex flex-col">
                <h2 class="text-xl font-semibold text-gray-800 mb-3 border-b pb-2">‚öôÔ∏è Einstellungen</h2>
                
                <div class="space-y-3 flex-1">
                    <p class="text-sm text-gray-600">Pro Schicht werden 7 Spieler ben√∂tigt (1 Putzmaschine + 6 Crew).</p>
                    
                    <label class="flex items-center gap-3 bg-blue-50 p-3 rounded-lg cursor-pointer hover:bg-blue-100">
                        <input type="radio" name="variant" value="1" checked class="form-radio text-indigo-600 h-4 w-4">
                        <div>
                            <span class="font-medium text-gray-700">Eine Schicht</span>
                            <p class="text-xs text-gray-500">7 Spieler putzen</p>
                        </div>
                    </label>
                    
                    <label class="flex items-center gap-3 bg-green-50 p-3 rounded-lg cursor-pointer hover:bg-green-100">
                        <input type="radio" name="variant" value="2" class="form-radio text-indigo-600 h-4 w-4">
                        <div>
                            <span class="font-medium text-gray-700">Zwei Schichten</span>
                            <p class="text-xs text-gray-500">14 Spieler (Fr√ºh + Sp√§t)</p>
                        </div>
                    </label>
                    
                    <div id="user-count-info" class="p-2 bg-yellow-100 text-yellow-800 rounded-lg text-sm text-center hidden"></div>
                </div>
                
                <button onclick="window.generatePutzplan()" class="mt-4 w-full py-3 bg-indigo-600 text-white font-bold text-lg rounded-xl hover:bg-indigo-700 transition-colors">
                    üé≤ Putzplan Generieren
                </button>
            </div>

            <!-- Ergebnis -->
            <div class="lg:col-span-1 container-card p-4">
                <h2 class="text-xl font-semibold text-gray-800 mb-3 border-b pb-2">üìã Ergebnis</h2>
                <div id="putzplan-result">
                    <p class="text-gray-500 text-sm">Klicke auf "Generieren" f√ºr eine faire Zuweisung.</p>
                </div>
                <div id="whatsapp-copy-container" class="hidden"></div>
            </div>
        </main>
        
        <!-- Action Buttons -->
        <div class="flex flex-wrap justify-center gap-3">
            <button onclick="window.toggleStatsModal()" class="text-indigo-600 hover:text-indigo-800 font-medium text-sm p-2 rounded-lg bg-white shadow-md">
                üìä Statistiken
            </button>
            <button onclick="window.toggleNachreichenModal()" class="text-orange-600 hover:text-orange-800 font-medium text-sm p-2 rounded-lg bg-white shadow-md border border-orange-300">
                üìù Nachreichen
            </button>
            <button onclick="window.exportStatsToCSV()" class="text-green-700 hover:text-green-900 font-medium text-sm p-2 rounded-lg bg-white shadow-md border border-green-300">
                üì• CSV Export
            </button>
            <button onclick="window.toggleResetModal()" class="text-red-600 hover:text-red-800 font-medium text-sm p-2 rounded-lg bg-white shadow-md">
                üóëÔ∏è Reset
            </button>
        </div>
    </div>
    
    <!-- Stats Modal -->
    <div id="stats-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 overflow-y-auto modal-container">
        <div class="container-card w-full max-w-5xl p-6 relative modal-scrollable-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">üìä Saison-Statistiken</h2>
            <button onclick="window.toggleStatsModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <div id="stats-card-container"></div>
            <p class="text-xs text-gray-500 mt-4">Klicke auf einen Spieler f√ºr Details.</p>
        </div>
    </div>
    
    <!-- Player Details Modal -->
    <div id="details-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 overflow-y-auto modal-container">
        <div class="container-card w-full max-w-md p-6 relative">
            <button onclick="document.getElementById('details-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <div id="details-modal-content"></div>
        </div>
    </div>
    
    <!-- Player Swap Modal (NEU) -->
    <div id="swap-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 overflow-y-auto modal-container">
        <div class="container-card w-full max-w-md p-6 relative">
            <button onclick="document.getElementById('swap-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <div id="swap-modal-content"></div>
        </div>
    </div>
    
    <!-- Nachreichen Modal (NEU) -->
    <div id="nachreichen-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 overflow-y-auto modal-container">
        <div class="container-card w-full max-w-lg p-6 relative modal-scrollable-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">üìù Putzdienst Nachreichen</h2>
            <button onclick="window.toggleNachreichenModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <div id="nachreichen-content"></div>
            <div class="flex justify-end gap-2 mt-4 pt-4 border-t">
                <button onclick="window.toggleNachreichenModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">
                    Abbrechen
                </button>
                <button onclick="window.saveNachreichen()" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded">
                    üíæ Nachreichen speichern
                </button>
            </div>
        </div>
    </div>

    <!-- Reset Modal -->
    <div id="reset-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
        <div class="container-card w-full max-w-md p-6 text-center">
            <h2 class="text-xl font-bold text-red-600 mb-3">‚ö†Ô∏è Wirklich alles l√∂schen?</h2>
            <p class="text-gray-700 mb-6">Alle Statistiken werden unwiderruflich gel√∂scht. Dies sollte nur am Saisonende gemacht werden.</p>
            <div class="flex justify-center gap-4">
                <button onclick="window.toggleResetModal()" class="py-2 px-4 bg-gray-300 text-gray-800 font-medium rounded-lg hover:bg-gray-400">Abbrechen</button>
                <button onclick="window.resetAllStats()" class="py-2 px-4 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700">Ja, alles l√∂schen</button>
            </div>
        </div>
    </div>
    
    <footer class="text-center text-gray-400 text-xs mt-8">
        v2.1 | Multi-Kriterien Fairness-Score | Cloud Sync | Editierbar & Nachreichen
    </footer>
</body>
</html>
